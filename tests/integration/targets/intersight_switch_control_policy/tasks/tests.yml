---
- block:
  - name: Define anchor for Intersight API login info
    ansible.builtin.set_fact:
      api_info: &api_info
        api_private_key: "{{ api_private_key }}"
        api_key_id: "{{ api_key_id }}"
        api_uri: "{{ api_uri | default(omit) }}"
        validate_certs: "{{ validate_certs | default(omit) }}"
        organization: "{{ organization }}"

  - name: Make sure Env is clean
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_switch_control_policy
      - test_switch_control_policy_custom
      - test_switch_control_policy_minimal
      - test_switch_control_policy_never_age

  - name: Create switch control policy - check-mode
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy
      description: "Test switch control policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      ethernet_switching_mode: end-host
      fc_switching_mode: end-host
      vlan_port_optimization_enabled: false
      reserved_vlan_start_id: 3915
      mac_aging_option: default
      message_interval: 15
      recovery_action: none
      fabric_pc_vhba_reset: disabled
    check_mode: true
    register: creation_res_check_mode

  - name: Verify switch control policy was not created - check-mode
    ansible.builtin.assert:
      that:
        - creation_res_check_mode is changed
        - creation_res_check_mode.api_response == {}

  - name: Create switch control policy
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy
      description: "Test switch control policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      ethernet_switching_mode: end-host
      fc_switching_mode: end-host
      vlan_port_optimization_enabled: false
      reserved_vlan_start_id: 3915
      mac_aging_option: default
      message_interval: 15
      recovery_action: none
      fabric_pc_vhba_reset: disabled
    register: creation_res

  - name: Fetch info after creation
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
      name: test_switch_control_policy
    register: creation_info_res

  - name: Verify switch control policy creation by info
    ansible.builtin.assert:
      that:
        - creation_res.changed
        - creation_info_res.api_response[0].Name == 'test_switch_control_policy'
        - creation_info_res.api_response[0].EthernetSwitchingMode == 'end-host'
        - creation_info_res.api_response[0].FcSwitchingMode == 'end-host'
        - creation_info_res.api_response[0].VlanPortOptimizationEnabled == false
        - creation_info_res.api_response[0].ReservedVlanStartId == 3915
        - creation_info_res.api_response[0].MacAgingSettings.MacAgingOption == 'Default'
        - creation_info_res.api_response[0].UdldSettings.MessageInterval == 15
        - creation_info_res.api_response[0].UdldSettings.RecoveryAction == 'none'
        - creation_info_res.api_response[0].FabricPcVhbaReset == 'Disabled'

  - name: Verify switch control policy creation response aligns with info response
    ansible.builtin.assert:
      that:
        - creation_res.api_response.Name == creation_info_res.api_response[0].Name
        - creation_res.api_response.EthernetSwitchingMode == creation_info_res.api_response[0].EthernetSwitchingMode
        - creation_res.api_response.FcSwitchingMode == creation_info_res.api_response[0].FcSwitchingMode
        - creation_res.api_response.VlanPortOptimizationEnabled == creation_info_res.api_response[0].VlanPortOptimizationEnabled

  - name: Create switch control policy (idempotency check)
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy
      description: "Test switch control policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      ethernet_switching_mode: end-host
      fc_switching_mode: end-host
      vlan_port_optimization_enabled: false
      reserved_vlan_start_id: 3915
      mac_aging_option: default
      message_interval: 15
      recovery_action: none
      fabric_pc_vhba_reset: disabled
    register: creation_res_ide

  - name: Verify switch control policy creation (idempotency check)
    ansible.builtin.assert:
      that:
        - not creation_res_ide.changed

  - name: Change settings on existing switch control policy
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy
      description: "Updated switch control policy description"
      ethernet_switching_mode: switch
      fc_switching_mode: switch
      vlan_port_optimization_enabled: true
      recovery_action: reset
      fabric_pc_vhba_reset: enabled
    register: changed_res

  - name: Fetch info after change
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
      name: test_switch_control_policy
    register: change_info_res

  - name: Verify switch control policy change by info
    ansible.builtin.assert:
      that:
        - changed_res.changed
        - change_info_res.api_response[0].Name == 'test_switch_control_policy'
        - change_info_res.api_response[0].EthernetSwitchingMode == 'switch'
        - change_info_res.api_response[0].FcSwitchingMode == 'switch'
        - change_info_res.api_response[0].VlanPortOptimizationEnabled == true
        - change_info_res.api_response[0].UdldSettings.RecoveryAction == 'reset'
        - change_info_res.api_response[0].FabricPcVhbaReset == 'Enabled'

  - name: Create switch control policy with custom MAC aging
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy_custom
      description: "Test switch control policy with custom MAC aging"
      ethernet_switching_mode: switch
      fc_switching_mode: switch
      vlan_port_optimization_enabled: true
      mac_aging_option: custom
      mac_aging_time: 14500
      message_interval: 20
      recovery_action: reset
      fabric_pc_vhba_reset: enabled
    register: creation_res_custom

  - name: Verify custom MAC aging policy creation
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
      name: test_switch_control_policy_custom
    register: creation_info_res_custom_verify

  - name: Verify custom policy has correct settings
    ansible.builtin.assert:
      that:
        - creation_res_custom.changed
        - creation_info_res_custom_verify.api_response[0].EthernetSwitchingMode == 'switch'
        - creation_info_res_custom_verify.api_response[0].FcSwitchingMode == 'switch'
        - creation_info_res_custom_verify.api_response[0].VlanPortOptimizationEnabled == true
        - creation_info_res_custom_verify.api_response[0].MacAgingSettings.MacAgingOption == 'Custom'
        - creation_info_res_custom_verify.api_response[0].MacAgingSettings.MacAgingTime == 14500
        - creation_info_res_custom_verify.api_response[0].UdldSettings.MessageInterval == 20
        - creation_info_res_custom_verify.api_response[0].UdldSettings.RecoveryAction == 'reset'
        - creation_info_res_custom_verify.api_response[0].FabricPcVhbaReset == 'Enabled'

  - name: Create a minimal switch control policy
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy_minimal
    register: creation_res_minimal

  - name: Fetch info for verification of minimal policy creation
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
      name: test_switch_control_policy_minimal
    register: creation_info_res_minimal

  - name: Verify minimal policy has correct default settings
    ansible.builtin.assert:
      that:
        - creation_res_minimal.changed
        - creation_info_res_minimal.api_response[0].EthernetSwitchingMode == 'end-host'
        - creation_info_res_minimal.api_response[0].FcSwitchingMode == 'end-host'
        - creation_info_res_minimal.api_response[0].VlanPortOptimizationEnabled == false
        - creation_info_res_minimal.api_response[0].ReservedVlanStartId == 3915
        - creation_info_res_minimal.api_response[0].MacAgingSettings.MacAgingOption == 'Default'
        - creation_info_res_minimal.api_response[0].UdldSettings.MessageInterval == 15
        - creation_info_res_minimal.api_response[0].UdldSettings.RecoveryAction == 'none'
        - creation_info_res_minimal.api_response[0].FabricPcVhbaReset == 'Disabled'

  - name: Create switch control policy with never aging MAC addresses
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: test_switch_control_policy_never_age
      description: "Test switch control policy with never aging MAC addresses"
      mac_aging_option: never
      message_interval: 25
    register: creation_res_never_age

  - name: Verify never aging policy creation
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
      name: test_switch_control_policy_never_age
    register: creation_info_res_never_age

  - name: Verify never aging policy has correct settings
    ansible.builtin.assert:
      that:
        - creation_res_never_age.changed
        - creation_info_res_never_age.api_response[0].MacAgingSettings.MacAgingOption == 'Never'
        - creation_info_res_never_age.api_response[0].UdldSettings.MessageInterval == 25

  - name: Fetch all switch control policies under selected organization
    cisco.intersight.intersight_switch_control_policy_info:
      <<: *api_info
    register: creation_info_res_final

  - name: Check that there are at least four switch control policies under this organization
    ansible.builtin.assert:
      that:
        - creation_info_res_final.api_response | length >= 4

  always:
  - name: Remove switch control policies
    cisco.intersight.intersight_switch_control_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_switch_control_policy
      - test_switch_control_policy_custom
      - test_switch_control_policy_minimal
      - test_switch_control_policy_never_age