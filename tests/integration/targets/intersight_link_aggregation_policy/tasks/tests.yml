---
- block:
  - name: Define anchor for Intersight API login info
    ansible.builtin.set_fact:
      api_info: &api_info
        api_private_key: "{{ api_private_key }}"
        api_key_id: "{{ api_key_id }}"
        api_uri: "{{ api_uri | default(omit) }}"
        validate_certs: "{{ validate_certs | default(omit) }}"
        organization: "{{ organization }}"

  - name: Make sure Env is clean
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_link_aggregation_policy
      - test_link_aggregation_policy_fast
      - test_link_aggregation_policy_minimal

  - name: Create link aggregation policy - check-mode
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy
      description: "Test link aggregation policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      suspend_individual: false
      lacp_rate: normal
    check_mode: true
    register: creation_res_check_mode

  - name: Verify link aggregation policy was not created - check-mode
    ansible.builtin.assert:
      that:
        - creation_res_check_mode is changed
        - creation_res_check_mode.api_response == {}

  - name: Create link aggregation policy
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy
      description: "Test link aggregation policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      suspend_individual: false
      lacp_rate: normal
    register: creation_res

  - name: Fetch info after creation
    cisco.intersight.intersight_link_aggregation_policy_info:
      <<: *api_info
      name: test_link_aggregation_policy
    register: creation_info_res

  - name: Verify link aggregation policy creation by info
    ansible.builtin.assert:
      that:
        - creation_res.changed
        - creation_info_res.api_response[0].Name == 'test_link_aggregation_policy'
        - creation_info_res.api_response[0].SuspendIndividual == false
        - creation_info_res.api_response[0].LacpRate == 'normal'

  - name: Verify link aggregation policy creation response aligns with info response
    ansible.builtin.assert:
      that:
        - creation_res.api_response.Name == creation_info_res.api_response[0].Name
        - creation_res.api_response.SuspendIndividual == creation_info_res.api_response[0].SuspendIndividual
        - creation_res.api_response.LacpRate == creation_info_res.api_response[0].LacpRate

  - name: Create link aggregation policy (idempotency check)
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy
      description: "Test link aggregation policy description"
      tags:
        - Key: Site
          Value: Test
        - Key: Environment
          Value: Testing
      suspend_individual: false
      lacp_rate: normal
    register: creation_res_ide

  - name: Verify link aggregation policy creation (idempotency check)
    ansible.builtin.assert:
      that:
        - not creation_res_ide.changed

  - name: Change settings on existing link aggregation policy
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy
      description: "Updated link aggregation policy description"
      suspend_individual: true
      lacp_rate: fast
    register: changed_res

  - name: Fetch info after change
    cisco.intersight.intersight_link_aggregation_policy_info:
      <<: *api_info
      name: test_link_aggregation_policy
    register: change_info_res

  - name: Verify link aggregation policy change by info
    ansible.builtin.assert:
      that:
        - changed_res.changed
        - change_info_res.api_response[0].Name == 'test_link_aggregation_policy'
        - change_info_res.api_response[0].SuspendIndividual == true
        - change_info_res.api_response[0].LacpRate == 'fast'

  - name: Create link aggregation policy with fast LACP rate
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy_fast
      description: "Test link aggregation policy with fast LACP rate"
      suspend_individual: true
      lacp_rate: fast
    register: creation_res_fast

  - name: Verify fast LACP rate policy creation
    cisco.intersight.intersight_link_aggregation_policy_info:
      <<: *api_info
      name: test_link_aggregation_policy_fast
    register: creation_info_res_fast_verify

  - name: Verify fast policy has correct settings
    ansible.builtin.assert:
      that:
        - creation_res_fast.changed
        - creation_info_res_fast_verify.api_response[0].SuspendIndividual == true
        - creation_info_res_fast_verify.api_response[0].LacpRate == 'fast'

  - name: Create a minimal link aggregation policy
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: test_link_aggregation_policy_minimal
    register: creation_res_minimal

  - name: Fetch info for verification of minimal policy creation
    cisco.intersight.intersight_link_aggregation_policy_info:
      <<: *api_info
      name: test_link_aggregation_policy_minimal
    register: creation_info_res_minimal

  - name: Verify minimal policy has correct default settings
    ansible.builtin.assert:
      that:
        - creation_res_minimal.changed
        - creation_info_res_minimal.api_response[0].SuspendIndividual == false
        - creation_info_res_minimal.api_response[0].LacpRate == 'normal'

  - name: Fetch all link aggregation policies under selected organization
    cisco.intersight.intersight_link_aggregation_policy_info:
      <<: *api_info
    register: creation_info_res_final

  - name: Check that there are at least three link aggregation policies under this organization
    ansible.builtin.assert:
      that:
        - creation_info_res_final.api_response | length >= 3

  always:
  - name: Remove link aggregation policies
    cisco.intersight.intersight_link_aggregation_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_link_aggregation_policy
      - test_link_aggregation_policy_fast
      - test_link_aggregation_policy_minimal