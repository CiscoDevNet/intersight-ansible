---
- block:
  - name: Define anchor for Intersight API login info
    ansible.builtin.set_fact:
      api_info: &api_info
        api_private_key: "{{ api_private_key }}"
        api_key_id: "{{ api_key_id }}"
        api_uri: "{{ api_uri | default(omit) }}"
        validate_certs: "{{ validate_certs | default(omit) }}"
        organization: "{{ organization }}"

  - name: Make sure Env is clean
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_memory_policy_basic
      - test_memory_policy_disabled
      - test_memory_policy_updated

  - name: Create basic Memory policy - check-mode
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_basic
      description: "Test basic Memory policy"
      enable_dimm_blocklisting: true
      tags:
        - Key: Site
          Value: Test
    check_mode: true
    register: basic_creation_check_mode

  - name: Verify basic Memory policy was not created - check-mode
    ansible.builtin.assert:
      that:
        - basic_creation_check_mode is changed
        - basic_creation_check_mode.api_response == {}

  - name: Create basic Memory policy
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_basic
      description: "Test basic Memory policy"
      enable_dimm_blocklisting: true
      tags:
        - Key: Site
          Value: Test
    register: basic_creation

  - name: Verify basic Memory policy creation
    ansible.builtin.assert:
      that:
        - basic_creation is changed
        - basic_creation.api_response.Name == 'test_memory_policy_basic'
        - basic_creation.api_response.Moid is defined
        - basic_creation.api_response.ObjectType == 'memory.Policy'
        - basic_creation.api_response.EnableDimmBlocklisting == true

  - name: Create basic Memory policy (idempotency check)
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_basic
      description: "Test basic Memory policy"
      enable_dimm_blocklisting: true
      tags:
        - Key: Site
          Value: Test
    register: basic_creation_ide

  - name: Verify basic Memory policy creation (idempotency check)
    ansible.builtin.assert:
      that:
        - basic_creation_ide is not changed

  - name: Create disabled Memory policy
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_disabled
      description: "Test disabled Memory policy"
      enable_dimm_blocklisting: false
      tags:
        - Key: Environment
          Value: Test
    register: disabled_creation

  - name: Verify disabled Memory policy creation
    ansible.builtin.assert:
      that:
        - disabled_creation is changed
        - disabled_creation.api_response.Name == 'test_memory_policy_disabled'
        - disabled_creation.api_response.EnableDimmBlocklisting == false

  - name: Create disabled Memory policy (idempotency check)
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_disabled
      description: "Test disabled Memory policy"
      enable_dimm_blocklisting: false
      tags:
        - Key: Environment
          Value: Test
    register: disabled_creation_ide

  - name: Verify disabled Memory policy creation (idempotency check)
    ansible.builtin.assert:
      that:
        - disabled_creation_ide is not changed

  - name: Update Memory policy
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_disabled
      description: "Updated disabled Memory policy"
      enable_dimm_blocklisting: false
      tags:
        - Key: Environment
          Value: Updated
    register: disabled_update

  - name: Verify disabled Memory policy update
    ansible.builtin.assert:
      that:
        - disabled_update is changed
        - disabled_update.api_response.Description == 'Updated disabled Memory policy'

  - name: Get specific Memory policy by name
    cisco.intersight.intersight_memory_policy_info:
      <<: *api_info
      name: test_memory_policy_basic
    register: memory_policy_info_by_name

  - name: Verify specific Memory policy info
    ansible.builtin.assert:
      that:
        - memory_policy_info_by_name.api_response is defined
        - memory_policy_info_by_name.api_response | length > 0
        - memory_policy_info_by_name.api_response[0].Name == 'test_memory_policy_basic'

  - name: Delete Memory policy
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_basic
      state: absent
    register: memory_policy_delete

  - name: Verify Memory policy deletion
    ansible.builtin.assert:
      that:
        - memory_policy_delete is changed

  - name: Delete Memory policy (idempotency check)
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: test_memory_policy_basic
      state: absent
    register: memory_policy_delete_ide

  - name: Verify Memory policy deletion (idempotency check)
    ansible.builtin.assert:
      that:
        - memory_policy_delete_ide is not changed

  always:
  - name: Remove all test Memory policies
    cisco.intersight.intersight_memory_policy:
      <<: *api_info
      name: "{{ item }}"
      state: absent
    loop:
      - test_memory_policy_basic
      - test_memory_policy_disabled
      - test_memory_policy_updated