---
- name: Define anchor for Intersight API login info
  ansible.builtin.set_fact:
    api_info: &api_info
      api_private_key: "{{ api_private_key }}"
      api_key_id: "{{ api_key_id }}"
      organization: "{{ organization }}"

- name: Make sure Environment is clean
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: "{{ item }}"
    state: absent
  loop:
    - test_cert_mgmt_rootca
    - test_cert_mgmt_imc
    - test_cert_mgmt_both

- name: Create Certificate Management Policy with Root CA certificate - check mode
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_rootca
    description: "Test policy with Root CA certificate"
    tags:
      - Key: "TestType"
        Value: "RootCA"
    certificates:
      - certificate_type: rootca
        certificate_name: "TestRootCA01"
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBVENDQXVtZ0F3SUJBZ0lVQ3FQNUtFMXFOYWFnckxUeUdKem9UTnliNnlBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SRXdEd1lEVlFRSApEQWhUWVc0Z1NtOXpaVEVPTUF3R0ExVUVDZ3dGUTJselkyOHhDekFKQmdOVkJBc01Ba2xVTVJrd0Z3WURWUVFECkRCQjBaWE4wTG1WNFlXMXdiR1V1WTI5dE1TQXdIZ1lKS29aSWh2Y05BUWtCRmhGaFpHMXBia0JsZUdGdGNHeGwKTG1OdmJUQWVGdzB5TlRFeU1ETXdPVEEzTURKYUZ3MHlOakV5TURNd09UQTNNREphTUlHUE1Rc3dDUVlEVlFRRwpFd0pWVXpFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVJNQThHQTFVRUJ3d0lVMkZ1SUVwdmMyVXhEakFNCkJnTlZCQW9NQlVOcGMyTnZNUXN3Q1FZRFZRUUxEQUpKVkRFWk1CY0dBMVVFQXd3UWRHVnpkQzVsZUdGdGNHeGwKTG1OdmJURWdNQjRHQ1NxR1NJYjNEUUVKQVJZUllXUnRhVzVBWlhoaGJYQnNaUzVqYjIwd2dnRWlNQTBHQ1NxRwpTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDeDk4dkpGZ0krQThodmVWbUpRdTNIYURHNnJXRTJUMVM2Ci9URXo0TXB2TE9RVWlmVTg1K2QyMWo2b2JESklwZEJxUlk5MUZMKy9qcmEwZTJyWWNlR2YxczZPUFp1dzBYWWwKY0ZjQkQyeXVtcWZ6VHFQeWhNc3l0L1hqdEkrd2hlcHFKeHhiVW5iOEVEL1JnWmw0bEN5ZG5kMlFKTUduQW9IRQovM0FtR2t1UFQxOEdpMWk1M0k3N3I2OG5Dd0xlK1pkaVhvVDE1WERtTTRxWXEzUFRFVjVTcFZPMityTWloTjc1CjBnZ3h6VzM1NDdtTTlXNGJMMW1nWkdZRTdjNmdZMDhENUZncmNSbGZQSEhzeS8zVHZWbS9LV09Da0s3RHBVUGsKNXVpdEZCSzVYY3N3MHgxaUx4bFVsS29CVGRSNnBCZmtaWjhjczllYVJOSGVpbzUyc29FdEFnTUJBQUdqVXpCUgpNQjBHQTFVZERnUVdCQlJJcWxsdXNkbTIrazZwVklETUxNeWFHb1c4b1RBZkJnTlZIU01FR0RBV2dCUklxbGx1CnNkbTIrazZwVklETUxNeWFHb1c4b1RBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ2tON0tXK05CTWl6STFRSlpWNnVCbTcxT3RReTNlRkpsKzF3TWJNNHk1UFlTVTBPeG82R29jd1hkMgpSYVV1Z2VlQ240WHRkWGVSdHczY0ltTXppMUc2NXh0S1hGR0ZWRUx1NDkyV2hIQ1JySGNnREFMR3dpZkpmM0oyCnNJVDJiSC9YR3JvSDByalJVaG5hSTVvQkY1RXJodFRQL3AzRUJRVFQ4UTBqWUdRSTVGazdVbXA5Y3hjcTFMTEEKQmZwK1hWc0dwaFVoZ2xiR2dpSXQ5NFF2WkVIYkk1K0hNOWFjUGFLMEo0WmhxS0tiUHgwR082TXVLTjkyTUE3Mwo2eWJWWFl4RUJpWDkyNFJ2N2I3aUUwYTZpM0ltZnRmdXJxMUhPa3lEVndJRFQxTWlGc3pieXkvYnZaREFrZ2RsCm42TjFMYUdENGpQMncxUmdCcXNTSk9wVWdwSEcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
        enabled: true
    state: present
  check_mode: true
  register: result

- name: Verify check mode - policy not created
  ansible.builtin.assert:
    that:
      - result is changed
      - result.api_response == {}

- name: Create Certificate Management Policy with Root CA certificate
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_rootca
    description: "Test policy with Root CA certificate"
    tags:
      - Key: "TestType"
        Value: "RootCA"
    certificates:
      - certificate_type: rootca
        certificate_name: "TestRootCA01"
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBVENDQXVtZ0F3SUJBZ0lVQ3FQNUtFMXFOYWFnckxUeUdKem9UTnliNnlBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SRXdEd1lEVlFRSApEQWhUWVc0Z1NtOXpaVEVPTUF3R0ExVUVDZ3dGUTJselkyOHhDekFKQmdOVkJBc01Ba2xVTVJrd0Z3WURWUVFECkRCQjBaWE4wTG1WNFlXMXdiR1V1WTI5dE1TQXdIZ1lKS29aSWh2Y05BUWtCRmhGaFpHMXBia0JsZUdGdGNHeGwKTG1OdmJUQWVGdzB5TlRFeU1ETXdPVEEzTURKYUZ3MHlOakV5TURNd09UQTNNREphTUlHUE1Rc3dDUVlEVlFRRwpFd0pWVXpFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVJNQThHQTFVRUJ3d0lVMkZ1SUVwdmMyVXhEakFNCkJnTlZCQW9NQlVOcGMyTnZNUXN3Q1FZRFZRUUxEQUpKVkRFWk1CY0dBMVVFQXd3UWRHVnpkQzVsZUdGdGNHeGwKTG1OdmJURWdNQjRHQ1NxR1NJYjNEUUVKQVJZUllXUnRhVzVBWlhoaGJYQnNaUzVqYjIwd2dnRWlNQTBHQ1NxRwpTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDeDk4dkpGZ0krQThodmVWbUpRdTNIYURHNnJXRTJUMVM2Ci9URXo0TXB2TE9RVWlmVTg1K2QyMWo2b2JESklwZEJxUlk5MUZMKy9qcmEwZTJyWWNlR2YxczZPUFp1dzBYWWwKY0ZjQkQyeXVtcWZ6VHFQeWhNc3l0L1hqdEkrd2hlcHFKeHhiVW5iOEVEL1JnWmw0bEN5ZG5kMlFKTUduQW9IRQovM0FtR2t1UFQxOEdpMWk1M0k3N3I2OG5Dd0xlK1pkaVhvVDE1WERtTTRxWXEzUFRFVjVTcFZPMityTWloTjc1CjBnZ3h6VzM1NDdtTTlXNGJMMW1nWkdZRTdjNmdZMDhENUZncmNSbGZQSEhzeS8zVHZWbS9LV09Da0s3RHBVUGsKNXVpdEZCSzVYY3N3MHgxaUx4bFVsS29CVGRSNnBCZmtaWjhjczllYVJOSGVpbzUyc29FdEFnTUJBQUdqVXpCUgpNQjBHQTFVZERnUVdCQlJJcWxsdXNkbTIrazZwVklETUxNeWFHb1c4b1RBZkJnTlZIU01FR0RBV2dCUklxbGx1CnNkbTIrazZwVklETUxNeWFHb1c4b1RBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ2tON0tXK05CTWl6STFRSlpWNnVCbTcxT3RReTNlRkpsKzF3TWJNNHk1UFlTVTBPeG82R29jd1hkMgpSYVV1Z2VlQ240WHRkWGVSdHczY0ltTXppMUc2NXh0S1hGR0ZWRUx1NDkyV2hIQ1JySGNnREFMR3dpZkpmM0oyCnNJVDJiSC9YR3JvSDByalJVaG5hSTVvQkY1RXJodFRQL3AzRUJRVFQ4UTBqWUdRSTVGazdVbXA5Y3hjcTFMTEEKQmZwK1hWc0dwaFVoZ2xiR2dpSXQ5NFF2WkVIYkk1K0hNOWFjUGFLMEo0WmhxS0tiUHgwR082TXVLTjkyTUE3Mwo2eWJWWFl4RUJpWDkyNFJ2N2I3aUUwYTZpM0ltZnRmdXJxMUhPa3lEVndJRFQxTWlGc3pieXkvYnZaREFrZ2RsCm42TjFMYUdENGpQMncxUmdCcXNTSk9wVWdwSEcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
        enabled: true
    state: present
  register: result

- name: Verify Root CA policy creation
  ansible.builtin.assert:
    that:
      - result is changed
      - result.api_response.Name == 'test_cert_mgmt_rootca'
      - result.api_response.Description == 'Test policy with Root CA certificate'
      - result.api_response.Certificates is defined
      - result.api_response.Certificates | length == 1
      - result.api_response.Certificates[0].ObjectType == 'certificatemanagement.RootCaCertificate'
      - result.api_response.Certificates[0].CertificateName == 'TestRootCA01'
      - result.api_response.Certificates[0].Enabled == true

- name: Update same Root CA certificate (idempotency)
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_rootca
    description: "Test policy with Root CA certificate"
    tags:
      - Key: "TestType"
        Value: "RootCA"
    certificates:
      - certificate_type: rootca
        certificate_name: "TestRootCA01"
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBVENDQXVtZ0F3SUJBZ0lVQ3FQNUtFMXFOYWFnckxUeUdKem9UTnliNnlBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SRXdEd1lEVlFRSApEQWhUWVc0Z1NtOXpaVEVPTUF3R0ExVUVDZ3dGUTJselkyOHhDekFKQmdOVkJBc01Ba2xVTVJrd0Z3WURWUVFECkRCQjBaWE4wTG1WNFlXMXdiR1V1WTI5dE1TQXdIZ1lKS29aSWh2Y05BUWtCRmhGaFpHMXBia0JsZUdGdGNHeGwKTG1OdmJUQWVGdzB5TlRFeU1ETXdPVEEzTURKYUZ3MHlOakV5TURNd09UQTNNREphTUlHUE1Rc3dDUVlEVlFRRwpFd0pWVXpFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVJNQThHQTFVRUJ3d0lVMkZ1SUVwdmMyVXhEakFNCkJnTlZCQW9NQlVOcGMyTnZNUXN3Q1FZRFZRUUxEQUpKVkRFWk1CY0dBMVVFQXd3UWRHVnpkQzVsZUdGdGNHeGwKTG1OdmJURWdNQjRHQ1NxR1NJYjNEUUVKQVJZUllXUnRhVzVBWlhoaGJYQnNaUzVqYjIwd2dnRWlNQTBHQ1NxRwpTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDeDk4dkpGZ0krQThodmVWbUpRdTNIYURHNnJXRTJUMVM2Ci9URXo0TXB2TE9RVWlmVTg1K2QyMWo2b2JESklwZEJxUlk5MUZMKy9qcmEwZTJyWWNlR2YxczZPUFp1dzBYWWwKY0ZjQkQyeXVtcWZ6VHFQeWhNc3l0L1hqdEkrd2hlcHFKeHhiVW5iOEVEL1JnWmw0bEN5ZG5kMlFKTUduQW9IRQovM0FtR2t1UFQxOEdpMWk1M0k3N3I2OG5Dd0xlK1pkaVhvVDE1WERtTTRxWXEzUFRFVjVTcFZPMityTWloTjc1CjBnZ3h6VzM1NDdtTTlXNGJMMW1nWkdZRTdjNmdZMDhENUZncmNSbGZQSEhzeS8zVHZWbS9LV09Da0s3RHBVUGsKNXVpdEZCSzVYY3N3MHgxaUx4bFVsS29CVGRSNnBCZmtaWjhjczllYVJOSGVpbzUyc29FdEFnTUJBQUdqVXpCUgpNQjBHQTFVZERnUVdCQlJJcWxsdXNkbTIrazZwVklETUxNeWFHb1c4b1RBZkJnTlZIU01FR0RBV2dCUklxbGx1CnNkbTIrazZwVklETUxNeWFHb1c4b1RBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ2tON0tXK05CTWl6STFRSlpWNnVCbTcxT3RReTNlRkpsKzF3TWJNNHk1UFlTVTBPeG82R29jd1hkMgpSYVV1Z2VlQ240WHRkWGVSdHczY0ltTXppMUc2NXh0S1hGR0ZWRUx1NDkyV2hIQ1JySGNnREFMR3dpZkpmM0oyCnNJVDJiSC9YR3JvSDByalJVaG5hSTVvQkY1RXJodFRQL3AzRUJRVFQ4UTBqWUdRSTVGazdVbXA5Y3hjcTFMTEEKQmZwK1hWc0dwaFVoZ2xiR2dpSXQ5NFF2WkVIYkk1K0hNOWFjUGFLMEo0WmhxS0tiUHgwR082TXVLTjkyTUE3Mwo2eWJWWFl4RUJpWDkyNFJ2N2I3aUUwYTZpM0ltZnRmdXJxMUhPa3lEVndJRFQxTWlGc3pieXkvYnZaREFrZ2RsCm42TjFMYUdENGpQMncxUmdCcXNTSk9wVWdwSEcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
        enabled: true
    state: present
  register: result

- name: Verify idempotency for Root CA
  ansible.builtin.assert:
    that:
      - result is not changed

- name: Create Certificate Management Policy with IMC certificate
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_imc
    description: "Test policy with IMC certificate"
    certificates:
      - certificate_type: imc
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURNekNDQWh1Z0F3SUJBZ0lVRldSVDMrSWNtcy95VUZKQWZLYm9qUHFIdHJZd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1FqRUxNQWtHQTFVRUJoTUNXRmd4RlRBVEJnTlZCQWNNREVSbFptRjFiSFFnUTJsMGVURWNNQm9HQTFVRQpDZ3dUUkdWbVlYVnNkQ0JEYjIxd1lXNTVJRXgwWkRBZUZ3MHlOVEF5TURReE16UXdOVGhhRncweU56RXhNREl4Ck16UXdOVGhhTUVJeEN6QUpCZ05WQkFZVEFsaFlNUlV3RXdZRFZRUUhEQXhFWldaaGRXeDBJRU5wZEhreEhEQWEKQmdOVkJBb01FMFJsWm1GMWJIUWdRMjl0Y0dGdWVTQk1kR1F3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQgpEd0F3Z2dFS0FvSUJBUURHZGRvcnRaNFNlVDlaTE03eTJPM3JSN0s1Q3NjenZMdTlTb1R0UEgxOEQzWU0zUVNlClBBQnlYUUs3SVFuL1BQbTZCcEtzM3JLM3AvYXZUMVlud2t5RnNNT1o2SFUxSDQ5MTdPRldldkJ5WGdlZm01RGkKVGdBREcySVJVV0s0azlLYXJRM3ZaanJ4eXd0WFJtS1hPV2dTSnYxZXVWajRodnRTNjJ0QklwbEkzTzllSjRJRAp5R2E0OElvWGtOWlkzZHN2OHN1WnNhdlo5dE91MVg5SXp0VExWbkpaYSs3UnNobzVjenJuWUdrRzFOR3FUd2gzCm40ZXNCMFhLZklxYXo4YitBNFZNcmM5MEVrZjFucnNuaGRpaWFwbVVFcnYya2dVb2dCZk1hZXo0S1RWalhZR0QKQzdOWi9xVVZKNEdLQzJmUEI2OWNsT043OXFPeVBISEtEN0h6QWdNQkFBR2pJVEFmTUIwR0ExVWREZ1FXQkJUSApKTDUrSzEyc1RJbVZCbU1TZC83UXhuYUk5VEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbldDL2hEYXhZalJ6CnRoUWNLb0xRRElQNzA1L0IxL2t4ZmhpZktQamhuRElDcmJjN2xTcnE0bTZlRWoyb0FEOEx4RDJBOE5YTjdVNTQKOG9SNitsMEZ6V3FEMnY5WHhDWVlKVGJJTGFRdzJGZUZrc0t5U0xYWmZGVUN2UnRTcjlGZTZqUm94czRScE9WKwpOaE5USHFWQm9DOEdmck1Dd1E2dHlUNjkyVGFvblMxVVBObDZiU1BSQm5PSUhZQmpXaXdDMUc1QU1sVFpWOTJ4ClRMQUF0cHFYNEpoalhkVGJLL3Z4bWJCUGNvMWRJRUw3Vmh3NDcwTmgyZ0hzZWE1cXdhQ0JKOTkvKzJNTndsT1AKaVVYc2c4SWR5NTdvaGd0MGMyOTlxZWo0eVlrU09uUEUwRnZVeUpUYXdLdTVNMnNEejc0dWhNckdVSURuSmJpbwpDOHFmYU1FN0VRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ=="
        private_key: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRREdkZG9ydFo0U2VUOVoKTE03eTJPM3JSN0s1Q3NjenZMdTlTb1R0UEgxOEQzWU0zUVNlUEFCeVhRSzdJUW4vUFBtNkJwS3MzckszcC9hdgpUMVlud2t5RnNNT1o2SFUxSDQ5MTdPRldldkJ5WGdlZm01RGlUZ0FERzJJUlVXSzRrOUthclEzdlpqcnh5d3RYClJtS1hPV2dTSnYxZXVWajRodnRTNjJ0QklwbEkzTzllSjRJRHlHYTQ4SW9Ya05aWTNkc3Y4c3Vac2F2Wjl0T3UKMVg5SXp0VExWbkpaYSs3UnNobzVjenJuWUdrRzFOR3FUd2gzbjRlc0IwWEtmSXFhejhiK0E0Vk1yYzkwRWtmMQpucnNuaGRpaWFwbVVFcnYya2dVb2dCZk1hZXo0S1RWalhZR0RDN05aL3FVVko0R0tDMmZQQjY5Y2xPTjc5cU95ClBISEtEN0h6QWdNQkFBRUNnZ0VBQ2xkanlmbEp4bDZwRFdXSFZ5STBxNWp0MkRTV2tyeVg3OUl0UVF0dzRvRVAKdnJYWm9zRXZxTVh0K1lCTVBBK2FWN1kxK0dvV1YvbVpvaUw1TTFNdGw1M1JZM2k0ZXM4dE01RG5ZUkZBN0VTNApFdm9SUDZtZTJJcVp2cHRHRUtZclNFSVNRdEpKNmdXUmpyZXROWUlaU1REYzdRMnRkQzNjZE1LdHNSUXpkcGRzCi92OCs5TjcwZ0dBQ0pDa21nc1pKSkxUZDBjbUpFODBoRjVzTVp5UGdUOXRCblYrTVAxbWdPMWJ1VEhtd0Jub0gKcHJzOU1NMGE4SWNnSGNSdTNrOWEycFVaQ2dMUjFTTlYycitsZUxiTDNGTTloYkFqMHk4VGhBYXRTZm5HeFJHbAplN2RnMEhhVEdiRWJKdXgzN1dtMVNwTFVUbS9QM2xKWWVTZGZUSFFYR1FLQmdRRDlVNWg4U1pVY2l5TnZ0aHdtCjFKRmV4WmxJQi9pVDk0TlRHNGVRb0VrMldRWGdYT0xXVjZYOXAzMWh0aGRhNWJjQVFjZ2lReXJCTjdWYW1vNloKN0VtQTNoVUxVRG1BajNONlhmK0VwcHJLbXpIYk1zZ0dDeHp0bTYzcDU2WDlpc0o4cHUrQjBkQXRzREZsT3N1UwpFQjZNNFpLWit3Sk5xclhIb2VVUS9Ha29Yd0tCZ1FESWpnYStEYmRZN0FVakVGTFRwNTh0UVRHclFEWVJRemFqCjAveS9DdHBlWDNUUk5WaDVDWWxvSXNjRi9YeVhyTVRtM2FERWQrYXAvdXdsSkZnS2FkZGZQZjdZem9NcG83QisKdVhmRUFlajgyanh0cGx2RGllLzZ3YWZnVlNGdkJ0SHo3aERhdjB2bG1MSFRGQzh4aHlWbVZwODQwYUpOL2hDLwpuWUpNV2ZQdTdRS0JnSG5LZXdFbUR6NU4xcGVhb2lZNUJEcmdIVFY0UDVaRDVTdExqUDJIVWl1QzJVUm80OVhSCkJjalJnWUk4blRYaVF2MG9veU4xejFSZGlCOHJOMnZoSWVXRzMrODBmckRFUnV5SnpKTGwxbjJaNTNwUEM4TjgKREVoZ0ZGamtPZldQaExtUk9JemRab3pRcks3U2VaU2JrMVNBRG85aEVsWnN3RUJlSVZidFExRlpBb0dBVXFvZgo0MVI1LzBBQmVndHZhR2hOOXZSSlNjSUV4eWJDTGRMaCtjaTZhMjNERTd4K1JCMkhNcElySUsvMEcveU5pRzlQCnBjdWFHdlhGVmlYZDJDVDZMZnE2d1ppVmZhTkh5MlFkRm9DSERUblM4SXRDaFoya2VlSTZsUC9oOFFhSm9aYSsKQWJ3Wng0QWh3OVF0QTZnbDVVSE5EVGx6UWR4NEFOTW1jdHdjN0owQ2dZQlFSdFBCQ1pnWGZpeVpxbXNreEFCVApnK2YxQU9QN2g2emZ5Ukc1UmVwL2c1aTNsVXFxOWtxMHZocnJLWUJ4NG1sU2piS21oUHBTVzNQUlVIRHkyc24xCk04TTBRb0lOOTNHUUpzYUs1SFMrVHNwMjJyUUxxR2dZYmlEczVlM2RsbGRBbDlTTWxudkxOeU9YZFExQXhlY2kKY25LU01pek92TWhEWGdFb3IzSXFCUT09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0="
        enabled: true
    state: present
  register: result

- name: Verify IMC policy creation
  ansible.builtin.assert:
    that:
      - result is changed
      - result.api_response.Name == 'test_cert_mgmt_imc'
      - result.api_response.Description == 'Test policy with IMC certificate'
      - result.api_response.Certificates is defined
      - result.api_response.Certificates | length == 1
      - result.api_response.Certificates[0].ObjectType == 'certificatemanagement.Imc'
      - result.api_response.Certificates[0].Enabled == true

- name: Create Certificate Management Policy with both certificate types
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_both
    description: "Test policy with both certificate types"
    certificates:
      - certificate_type: rootca
        certificate_name: "TestRootCA02"
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBVENDQXVtZ0F3SUJBZ0lVQ3FQNUtFMXFOYWFnckxUeUdKem9UTnliNnlBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SRXdEd1lEVlFRSApEQWhUWVc0Z1NtOXpaVEVPTUF3R0ExVUVDZ3dGUTJselkyOHhDekFKQmdOVkJBc01Ba2xVTVJrd0Z3WURWUVFECkRCQjBaWE4wTG1WNFlXMXdiR1V1WTI5dE1TQXdIZ1lKS29aSWh2Y05BUWtCRmhGaFpHMXBia0JsZUdGdGNHeGwKTG1OdmJUQWVGdzB5TlRFeU1ETXdPVEEzTURKYUZ3MHlOakV5TURNd09UQTNNREphTUlHUE1Rc3dDUVlEVlFRRwpFd0pWVXpFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVJNQThHQTFVRUJ3d0lVMkZ1SUVwdmMyVXhEakFNCkJnTlZCQW9NQlVOcGMyTnZNUXN3Q1FZRFZRUUxEQUpKVkRFWk1CY0dBMVVFQXd3UWRHVnpkQzVsZUdGdGNHeGwKTG1OdmJURWdNQjRHQ1NxR1NJYjNEUUVKQVJZUllXUnRhVzVBWlhoaGJYQnNaUzVqYjIwd2dnRWlNQTBHQ1NxRwpTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDeDk4dkpGZ0krQThodmVWbUpRdTNIYURHNnJXRTJUMVM2Ci9URXo0TXB2TE9RVWlmVTg1K2QyMWo2b2JESklwZEJxUlk5MUZMKy9qcmEwZTJyWWNlR2YxczZPUFp1dzBYWWwKY0ZjQkQyeXVtcWZ6VHFQeWhNc3l0L1hqdEkrd2hlcHFKeHhiVW5iOEVEL1JnWmw0bEN5ZG5kMlFKTUduQW9IRQovM0FtR2t1UFQxOEdpMWk1M0k3N3I2OG5Dd0xlK1pkaVhvVDE1WERtTTRxWXEzUFRFVjVTcFZPMityTWloTjc1CjBnZ3h6VzM1NDdtTTlXNGJMMW1nWkdZRTdjNmdZMDhENUZncmNSbGZQSEhzeS8zVHZWbS9LV09Da0s3RHBVUGsKNXVpdEZCSzVYY3N3MHgxaUx4bFVsS29CVGRSNnBCZmtaWjhjczllYVJOSGVpbzUyc29FdEFnTUJBQUdqVXpCUgpNQjBHQTFVZERnUVdCQlJJcWxsdXNkbTIrazZwVklETUxNeWFHb1c4b1RBZkJnTlZIU01FR0RBV2dCUklxbGx1CnNkbTIrazZwVklETUxNeWFHb1c4b1RBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ2tON0tXK05CTWl6STFRSlpWNnVCbTcxT3RReTNlRkpsKzF3TWJNNHk1UFlTVTBPeG82R29jd1hkMgpSYVV1Z2VlQ240WHRkWGVSdHczY0ltTXppMUc2NXh0S1hGR0ZWRUx1NDkyV2hIQ1JySGNnREFMR3dpZkpmM0oyCnNJVDJiSC9YR3JvSDByalJVaG5hSTVvQkY1RXJodFRQL3AzRUJRVFQ4UTBqWUdRSTVGazdVbXA5Y3hjcTFMTEEKQmZwK1hWc0dwaFVoZ2xiR2dpSXQ5NFF2WkVIYkk1K0hNOWFjUGFLMEo0WmhxS0tiUHgwR082TXVLTjkyTUE3Mwo2eWJWWFl4RUJpWDkyNFJ2N2I3aUUwYTZpM0ltZnRmdXJxMUhPa3lEVndJRFQxTWlGc3pieXkvYnZaREFrZ2RsCm42TjFMYUdENGpQMncxUmdCcXNTSk9wVWdwSEcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
        enabled: true
      - certificate_type: imc
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURNekNDQWh1Z0F3SUJBZ0lVRldSVDMrSWNtcy95VUZKQWZLYm9qUHFIdHJZd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1FqRUxNQWtHQTFVRUJoTUNXRmd4RlRBVEJnTlZCQWNNREVSbFptRjFiSFFnUTJsMGVURWNNQm9HQTFVRQpDZ3dUUkdWbVlYVnNkQ0JEYjIxd1lXNTVJRXgwWkRBZUZ3MHlOVEF5TURReE16UXdOVGhhRncweU56RXhNREl4Ck16UXdOVGhhTUVJeEN6QUpCZ05WQkFZVEFsaFlNUlV3RXdZRFZRUUhEQXhFWldaaGRXeDBJRU5wZEhreEhEQWEKQmdOVkJBb01FMFJsWm1GMWJIUWdRMjl0Y0dGdWVTQk1kR1F3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQgpEd0F3Z2dFS0FvSUJBUURHZGRvcnRaNFNlVDlaTE03eTJPM3JSN0s1Q3NjenZMdTlTb1R0UEgxOEQzWU0zUVNlClBBQnlYUUs3SVFuL1BQbTZCcEtzM3JLM3AvYXZUMVlud2t5RnNNT1o2SFUxSDQ5MTdPRldldkJ5WGdlZm01RGkKVGdBREcySVJVV0s0azlLYXJRM3ZaanJ4eXd0WFJtS1hPV2dTSnYxZXVWajRodnRTNjJ0QklwbEkzTzllSjRJRAp5R2E0OElvWGtOWlkzZHN2OHN1WnNhdlo5dE91MVg5SXp0VExWbkpaYSs3UnNobzVjenJuWUdrRzFOR3FUd2gzCm40ZXNCMFhLZklxYXo4YitBNFZNcmM5MEVrZjFucnNuaGRpaWFwbVVFcnYya2dVb2dCZk1hZXo0S1RWalhZR0QKQzdOWi9xVVZKNEdLQzJmUEI2OWNsT043OXFPeVBISEtEN0h6QWdNQkFBR2pJVEFmTUIwR0ExVWREZ1FXQkJUSApKTDUrSzEyc1RJbVZCbU1TZC83UXhuYUk5VEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbldDL2hEYXhZalJ6CnRoUWNLb0xRRElQNzA1L0IxL2t4ZmhpZktQamhuRElDcmJjN2xTcnE0bTZlRWoyb0FEOEx4RDJBOE5YTjdVNTQKOG9SNitsMEZ6V3FEMnY5WHhDWVlKVGJJTGFRdzJGZUZrc0t5U0xYWmZGVUN2UnRTcjlGZTZqUm94czRScE9WKwpOaE5USHFWQm9DOEdmck1Dd1E2dHlUNjkyVGFvblMxVVBObDZiU1BSQm5PSUhZQmpXaXdDMUc1QU1sVFpWOTJ4ClRMQUF0cHFYNEpoalhkVGJLL3Z4bWJCUGNvMWRJRUw3Vmh3NDcwTmgyZ0hzZWE1cXdhQ0JKOTkvKzJNTndsT1AKaVVYc2c4SWR5NTdvaGd0MGMyOTlxZWo0eVlrU09uUEUwRnZVeUpUYXdLdTVNMnNEejc0dWhNckdVSURuSmJpbwpDOHFmYU1FN0VRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ=="
        private_key: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRREdkZG9ydFo0U2VUOVoKTE03eTJPM3JSN0s1Q3NjenZMdTlTb1R0UEgxOEQzWU0zUVNlUEFCeVhRSzdJUW4vUFBtNkJwS3MzckszcC9hdgpUMVlud2t5RnNNT1o2SFUxSDQ5MTdPRldldkJ5WGdlZm01RGlUZ0FERzJJUlVXSzRrOUthclEzdlpqcnh5d3RYClJtS1hPV2dTSnYxZXVWajRodnRTNjJ0QklwbEkzTzllSjRJRHlHYTQ4SW9Ya05aWTNkc3Y4c3Vac2F2Wjl0T3UKMVg5SXp0VExWbkpaYSs3UnNobzVjenJuWUdrRzFOR3FUd2gzbjRlc0IwWEtmSXFhejhiK0E0Vk1yYzkwRWtmMQpucnNuaGRpaWFwbVVFcnYya2dVb2dCZk1hZXo0S1RWalhZR0RDN05aL3FVVko0R0tDMmZQQjY5Y2xPTjc5cU95ClBISEtEN0h6QWdNQkFBRUNnZ0VBQ2xkanlmbEp4bDZwRFdXSFZ5STBxNWp0MkRTV2tyeVg3OUl0UVF0dzRvRVAKdnJYWm9zRXZxTVh0K1lCTVBBK2FWN1kxK0dvV1YvbVpvaUw1TTFNdGw1M1JZM2k0ZXM4dE01RG5ZUkZBN0VTNApFdm9SUDZtZTJJcVp2cHRHRUtZclNFSVNRdEpKNmdXUmpyZXROWUlaU1REYzdRMnRkQzNjZE1LdHNSUXpkcGRzCi92OCs5TjcwZ0dBQ0pDa21nc1pKSkxUZDBjbUpFODBoRjVzTVp5UGdUOXRCblYrTVAxbWdPMWJ1VEhtd0Jub0gKcHJzOU1NMGE4SWNnSGNSdTNrOWEycFVaQ2dMUjFTTlYycitsZUxiTDNGTTloYkFqMHk4VGhBYXRTZm5HeFJHbAplN2RnMEhhVEdiRWJKdXgzN1dtMVNwTFVUbS9QM2xKWWVTZGZUSFFYR1FLQmdRRDlVNWg4U1pVY2l5TnZ0aHdtCjFKRmV4WmxJQi9pVDk0TlRHNGVRb0VrMldRWGdYT0xXVjZYOXAzMWh0aGRhNWJjQVFjZ2lReXJCTjdWYW1vNloKN0VtQTNoVUxVRG1BajNONlhmK0VwcHJLbXpIYk1zZ0dDeHp0bTYzcDU2WDlpc0o4cHUrQjBkQXRzREZsT3N1UwpFQjZNNFpLWit3Sk5xclhIb2VVUS9Ha29Yd0tCZ1FESWpnYStEYmRZN0FVakVGTFRwNTh0UVRHclFEWVJRemFqCjAveS9DdHBlWDNUUk5WaDVDWWxvSXNjRi9YeVhyTVRtM2FERWQrYXAvdXdsSkZnS2FkZGZQZjdZem9NcG83QisKdVhmRUFlajgyanh0cGx2RGllLzZ3YWZnVlNGdkJ0SHo3aERhdjB2bG1MSFRGQzh4aHlWbVZwODQwYUpOL2hDLwpuWUpNV2ZQdTdRS0JnSG5LZXdFbUR6NU4xcGVhb2lZNUJEcmdIVFY0UDVaRDVTdExqUDJIVWl1QzJVUm80OVhSCkJjalJnWUk4blRYaVF2MG9veU4xejFSZGlCOHJOMnZoSWVXRzMrODBmckRFUnV5SnpKTGwxbjJaNTNwUEM4TjgKREVoZ0ZGamtPZldQaExtUk9JemRab3pRcks3U2VaU2JrMVNBRG85aEVsWnN3RUJlSVZidFExRlpBb0dBVXFvZgo0MVI1LzBBQmVndHZhR2hOOXZSSlNjSUV4eWJDTGRMaCtjaTZhMjNERTd4K1JCMkhNcElySUsvMEcveU5pRzlQCnBjdWFHdlhGVmlYZDJDVDZMZnE2d1ppVmZhTkh5MlFkRm9DSERUblM4SXRDaFoya2VlSTZsUC9oOFFhSm9aYSsKQWJ3Wng0QWh3OVF0QTZnbDVVSE5EVGx6UWR4NEFOTW1jdHdjN0owQ2dZQlFSdFBCQ1pnWGZpeVpxbXNreEFCVApnK2YxQU9QN2g2emZ5Ukc1UmVwL2c1aTNsVXFxOWtxMHZocnJLWUJ4NG1sU2piS21oUHBTVzNQUlVIRHkyc24xCk04TTBRb0lOOTNHUUpzYUs1SFMrVHNwMjJyUUxxR2dZYmlEczVlM2RsbGRBbDlTTWxudkxOeU9YZFExQXhlY2kKY25LU01pek92TWhEWGdFb3IzSXFCUT09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0="
        enabled: true
    state: present
  register: result

- name: Verify policy with both certificate types
  ansible.builtin.assert:
    that:
      - result is changed
      - result.api_response.Name == 'test_cert_mgmt_both'
      - result.api_response.Certificates | length == 2

- name: Update Certificate Management Policy description
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_rootca
    description: "Updated description"
    certificates:
      - certificate_type: rootca
        certificate_name: "TestRootCA01"
        certificate: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBVENDQXVtZ0F3SUJBZ0lVQ3FQNUtFMXFOYWFnckxUeUdKem9UTnliNnlBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SRXdEd1lEVlFRSApEQWhUWVc0Z1NtOXpaVEVPTUF3R0ExVUVDZ3dGUTJselkyOHhDekFKQmdOVkJBc01Ba2xVTVJrd0Z3WURWUVFECkRCQjBaWE4wTG1WNFlXMXdiR1V1WTI5dE1TQXdIZ1lKS29aSWh2Y05BUWtCRmhGaFpHMXBia0JsZUdGdGNHeGwKTG1OdmJUQWVGdzB5TlRFeU1ETXdPVEEzTURKYUZ3MHlOakV5TURNd09UQTNNREphTUlHUE1Rc3dDUVlEVlFRRwpFd0pWVXpFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVJNQThHQTFVRUJ3d0lVMkZ1SUVwdmMyVXhEakFNCkJnTlZCQW9NQlVOcGMyTnZNUXN3Q1FZRFZRUUxEQUpKVkRFWk1CY0dBMVVFQXd3UWRHVnpkQzVsZUdGdGNHeGwKTG1OdmJURWdNQjRHQ1NxR1NJYjNEUUVKQVJZUllXUnRhVzVBWlhoaGJYQnNaUzVqYjIwd2dnRWlNQTBHQ1NxRwpTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDeDk4dkpGZ0krQThodmVWbUpRdTNIYURHNnJXRTJUMVM2Ci9URXo0TXB2TE9RVWlmVTg1K2QyMWo2b2JESklwZEJxUlk5MUZMKy9qcmEwZTJyWWNlR2YxczZPUFp1dzBYWWwKY0ZjQkQyeXVtcWZ6VHFQeWhNc3l0L1hqdEkrd2hlcHFKeHhiVW5iOEVEL1JnWmw0bEN5ZG5kMlFKTUduQW9IRQovM0FtR2t1UFQxOEdpMWk1M0k3N3I2OG5Dd0xlK1pkaVhvVDE1WERtTTRxWXEzUFRFVjVTcFZPMityTWloTjc1CjBnZ3h6VzM1NDdtTTlXNGJMMW1nWkdZRTdjNmdZMDhENUZncmNSbGZQSEhzeS8zVHZWbS9LV09Da0s3RHBVUGsKNXVpdEZCSzVYY3N3MHgxaUx4bFVsS29CVGRSNnBCZmtaWjhjczllYVJOSGVpbzUyc29FdEFnTUJBQUdqVXpCUgpNQjBHQTFVZERnUVdCQlJJcWxsdXNkbTIrazZwVklETUxNeWFHb1c4b1RBZkJnTlZIU01FR0RBV2dCUklxbGx1CnNkbTIrazZwVklETUxNeWFHb1c4b1RBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ2tON0tXK05CTWl6STFRSlpWNnVCbTcxT3RReTNlRkpsKzF3TWJNNHk1UFlTVTBPeG82R29jd1hkMgpSYVV1Z2VlQ240WHRkWGVSdHczY0ltTXppMUc2NXh0S1hGR0ZWRUx1NDkyV2hIQ1JySGNnREFMR3dpZkpmM0oyCnNJVDJiSC9YR3JvSDByalJVaG5hSTVvQkY1RXJodFRQL3AzRUJRVFQ4UTBqWUdRSTVGazdVbXA5Y3hjcTFMTEEKQmZwK1hWc0dwaFVoZ2xiR2dpSXQ5NFF2WkVIYkk1K0hNOWFjUGFLMEo0WmhxS0tiUHgwR082TXVLTjkyTUE3Mwo2eWJWWFl4RUJpWDkyNFJ2N2I3aUUwYTZpM0ltZnRmdXJxMUhPa3lEVndJRFQxTWlGc3pieXkvYnZaREFrZ2RsCm42TjFMYUdENGpQMncxUmdCcXNTSk9wVWdwSEcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
        enabled: true
    state: present
  register: result

- name: Verify policy update
  ansible.builtin.assert:
    that:
      - result is changed
      - result.api_response.Description == 'Updated description'

- name: Fetch specific Certificate Management Policy by name
  cisco.intersight.intersight_certificate_management_policy_info:
    <<: *api_info
    name: test_cert_mgmt_both
  register: result

- name: Verify info module result for specific policy
  ansible.builtin.assert:
    that:
      - result.api_response is defined
      - result.api_response | length > 0
      - result.api_response[0].Name == 'test_cert_mgmt_both'

- name: Delete all test Certificate Management Policies
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: "{{ item }}"
    state: absent
  loop:
    - test_cert_mgmt_rootca
    - test_cert_mgmt_imc
    - test_cert_mgmt_both
  register: result

- name: Verify policy deletion
  ansible.builtin.assert:
    that:
      - result.results[0] is changed
      - result.results[1] is changed
      - result.results[2] is changed

- name: Verify Certificate Management Policies are deleted
  cisco.intersight.intersight_certificate_management_policy:
    <<: *api_info
    name: test_cert_mgmt_rootca
    state: absent
  register: result

- name: Verify no change after deletion
  ansible.builtin.assert:
    that:
      - result is not changed
